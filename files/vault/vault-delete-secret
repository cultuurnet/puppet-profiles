#!/bin/bash

# Script to delete vault secrets (both data and metadata)
# Usage: vault-delete-secret <path_to_secret> (relative to the mount point)

set -e

# Check if running as root
if [ "$(id -u)" -ne 0 ]; then
    echo "Error: This script must be run as root"
    exit 1
fi

# Define vault command to run as vault user
vault_cmd='su - vault -c /usr/bin/vault'

if [ $# -ne 1 ]; then
    echo "Usage: $0 <path_to_secret>"
    exit 1
fi

SECRET_PATH="$1"
MOUNT="puppet"

echo "Deleting secret at path: ${SECRET_PATH}"

# Get metadata to check if secret exists and get current version
echo "Getting metadata for secret..."
if ! $vault_cmd kv metadata get -mount="${MOUNT}" "${SECRET_PATH}" >/dev/null 2>&1; then
    echo "Secret not found at path: ${SECRET_PATH}"
    exit 1
fi

# Get current version and destroy all versions from 1 to current
CURRENT_VERSION=$($vault_cmd kv metadata get -format=json -mount="${MOUNT}" "${SECRET_PATH}" | /usr/bin/jq -r '.data.metadata.version')

if [ -n "$CURRENT_VERSION" ] && [ "$CURRENT_VERSION" -gt 0 ]; then
    echo "Found ${CURRENT_VERSION} version(s) of the secret"
    VERSIONS=$(seq -s ',' 1 $CURRENT_VERSION)
    echo "Versions to destroy: ${VERSIONS}"
    $vault_cmd kv destroy -versions="${VERSIONS}" -mount="${MOUNT}" "${SECRET_PATH}"
    echo "Secret data destroyed successfully"
fi

echo "Deleting secret metadata..."
$vault_cmd kv metadata delete -mount="${MOUNT}" "${SECRET_PATH}"
echo "Secret metadata deleted successfully"

echo "Secret ${SECRET_PATH} has been completely removed from Vault"