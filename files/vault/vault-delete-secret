#!/bin/bash

# Script to delete vault secrets (both data and metadata)
# Usage: vault-delete-secret <path_to_secret> (relative to the mount point)

set -e

if [ $# -ne 1 ]; then
    echo "Usage: $0 <path_to_secret>"
    exit 1
fi

SECRET_PATH="$1"
MOUNT="puppet"

echo "Deleting secret at path: ${SECRET_PATH}"

# Get metadata to check if secret exists and get current version
echo "Getting metadata for secret..."
if ! /usr/bin/vault kv metadata get -mount="${MOUNT}" "${SECRET_PATH}" >/dev/null 2>&1; then
    echo "Secret not found at path: ${SECRET_PATH}"
    exit 1
fi

# Get current version and destroy all versions from 1 to current
CURRENT_VERSION=$(/usr/bin/vault kv metadata get -mount="${MOUNT}" "${SECRET_PATH}" | grep "current_version" | awk '{print $2}')

if [ -n "$CURRENT_VERSION" ] && [ "$CURRENT_VERSION" -gt 0 ]; then
    echo "Found ${CURRENT_VERSION} version(s) of the secret"
    VERSIONS=$(seq -s ',' 1 $CURRENT_VERSION)
    echo "Versions to destroy: ${VERSIONS}"
    /usr/bin/vault kv destroy -versions="${VERSIONS}" -mount="${MOUNT}" "${SECRET_PATH}"
    echo "Secret data destroyed successfully"
fi

echo "Deleting secret metadata..."
/usr/bin/vault kv metadata delete -mount="${MOUNT}" "${SECRET_PATH}"
echo "Secret metadata deleted successfully"

echo "Secret ${SECRET_PATH} has been completely removed from Vault"