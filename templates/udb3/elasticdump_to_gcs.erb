#!/bin/bash

gcs_bucket_name=<%= @gcs_bucket_name %>
bucket_mountpoint=/mnt/gcs/cloud-composer
index_name=<%= @index_name %>
limit=<%= @batch_size %>

OPTIND=1

while getopts "s?" OPTION
do
    case ${OPTION} in
    s)
        source_only=true
        suffix=''
        ;;
    *)
        echo "Incorrect options provided"
        exit 1
        ;;
    esac
done

function cleanup()
{
    fusermount -u ${bucket_mountpoint}
}

trap cleanup EXIT

date=$(TZ=UTC date +%Y%m%d)

echo "Mounting GCS bucket ${gcs_bucket_name} on ${bucket_mountpoint}"
gcsfuse --implicit-dirs --key-file /etc/gcs_credentials.json ${gcs_bucket_name} ${bucket_mountpoint}

echo "Dumping index ${index_name} to file ${bucket_mountpoint}/data/import/${index_name}_${date}.json"
/usr/local/bin/elasticdump --input http://localhost:9200/${index_name} --type data --limit ${limit} --sourceOnly ${source_only:-false} --output ${bucket_mountpoint}/data/import/${index_name}${suffix:-_full}_${date}.json
