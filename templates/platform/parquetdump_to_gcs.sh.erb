#!/bin/bash

database_name=<%= @database_name %>
database_password=<%= @database_password %>
dump_empty_tables=<%= @dump_empty_tables %>
date_yesterday=$(date -d "yesterday" +%Y-%m-%d)
data_contract_version=1

for database_table in $(mysql -h 127.0.0.1 -u sling -p${database_password} ${database_name} --batch --skip-column-names -e 'show tables;')
do
    SLING_ALLOW_EMPTY=${dump_empty_tables} /usr/local/bin/sling run --src-conn "${database_name}" --src-stream "${database_name}.${database_table}" --tgt-conn 'publiq-ingestion' --tgt-object "platform/${database_table}/v${data_contract_version}/${date_yesterday}/${database_table}.parquet"
done
